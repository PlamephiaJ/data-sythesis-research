<!doctype html>
<html class="no-js" lang="en" data-content_root="../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Diffusers Library for Quickly Building and Deploying Diffusion Models" href="../tools/diffusers.html" /><link rel="prev" title="Datasets" href="datasets.html" />

    <!-- Generated with Sphinx 8.2.3 and Furo 2025.07.19 -->
        <title>Rule-guided Diffusion - Phish-Generator 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=d111a655" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=25af2a20" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #2b2b2b;
  --color-code-foreground: #f8f8f2;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #2b2b2b;
  --color-code-foreground: #f8f8f2;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">Phish-Generator 0.0.1 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  <span class="sidebar-brand-text">Phish-Generator 0.0.1 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">GETTING STARTED</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../start/install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../start/install.html#pre-requisites">Pre-requisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../start/install.html#install-dependencies">Install Dependencies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../start/install.html#post-installation">Post-installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../start/quickstart.html">Quickstart: BERT Pre-trained Model Fine-tuning on WAF Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../start/codestyle.html">codestyle</a></li>
<li class="toctree-l1"><a class="reference internal" href="readme.html">Project Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="readme.html#design-principles">Design Principles</a></li>
<li class="toctree-l1"><a class="reference internal" href="readme.html#functional-architecture">Functional Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="readme.html#core-modules">Core Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="datasets.html">Datasets</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Rule-guided Diffusion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/diffusers.html">Diffusers Library for Quickly Building and Deploying Diffusion Models</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="../_sources/design/rule-guided_diffusion.md.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="rule-guided-diffusion">
<h1>Rule-guided Diffusion<a class="headerlink" href="#rule-guided-diffusion" title="Link to this heading">¶</a></h1>
<p>The diffusion model is one of the earliest generative models used for image generation, and in recent years it has also been applied to text generation tasks. Compared with traditional Transformer-based text generation models, diffusion models perform remarkably well in terms of diversity and quality. However, approaches that rely purely on data-driven generation may overlook domain-specific rules and constraints, leading to results that do not meet expectations. In phishing email generation, following certain rules (such as including specific phishing keywords or mimicking the format of real emails) is crucial for producing high-quality phishing emails. To address this issue, we aim to explore a rule-guided diffusion model approach that integrates rules into the generation process, thereby improving both the quality and diversity of phishing email outputs.</p>
<section id="methodology">
<h2>Methodology<a class="headerlink" href="#methodology" title="Link to this heading">¶</a></h2>
<section id="the-process-of-diffusion-models">
<h3>The process of diffusion models<a class="headerlink" href="#the-process-of-diffusion-models" title="Link to this heading">¶</a></h3>
<ul>
<li><p>Forward process (adding noise):</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[q(x_t|x_{t-1})=\mathcal{N}(x_t;\sqrt{1-\beta_t}x_{t-1},\beta_tI)\]</div>
</div>
<p>In the text scenario, this can be: token embedding → add noise → obtain <span class="math notranslate nohighlight">\(x_t\)</span>.</p>
</li>
<li><p>Reverse process (denoising):</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[p_\theta(x_{t-1}|x_t,cond)=\mathcal{N}(x_{t-1};\mu_\theta(x_t,t,cond),\Sigma_\theta(x_t,t,cond))\]</div>
</div>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\mu_\theta(x_t,t,cond)=\frac{1}{\sqrt{1-\beta_t}}\left(x_t-\frac{\beta_t}{\sqrt{1-\bar{\alpha}_t}}\epsilon_\theta(x_t,t,cond)\right)\]</div>
</div>
<p>The model learns <span class="math notranslate nohighlight">\(\epsilon_\theta(x_t,t,\mathrm{cond})\)</span> and gradually recovers <span class="math notranslate nohighlight">\(x_0\)</span>.</p>
</li>
<li><p>Training objective:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[L_{simple}=\mathbb{E}_{t,x_0,\epsilon}[\|\epsilon-\epsilon_\theta(x_t,t,\mathrm{cond})\|^2]\]</div>
</div>
</li>
</ul>
</section>
<section id="incorporate-rules-into-diffusion">
<h3>Incorporate rules into diffusion<a class="headerlink" href="#incorporate-rules-into-diffusion" title="Link to this heading">¶</a></h3>
<p>Rules can be integrated into the diffusion process during the noise prediction / sampling constraint stages:</p>
<ol class="arabic">
<li><p>Classifier / Guidance style (Inference-time rule guidance, plug-and-play)</p>
<ul>
<li><p>Treat the rule <span class="math notranslate nohighlight">\(R\)</span> as a “constraint classifier”:</p>
<ul class="simple">
<li><p>At each denoising step, compute whether the generated sample satisfies the rule.</p></li>
<li><p>If it deviates from the rule, modify the noise gradient (similar to classifier guidance).</p></li>
<li><p>Formally:</p></li>
</ul>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\nabla_{x_t}\log p(x_t|R)\approx\nabla_{x_t}\log p_\theta(x_t)+w\cdot\nabla_{x_t}\log p(R|x_t)\]</div>
</div>
</li>
</ul>
</li>
<li><p>Rules encoded as condition vectors (In-training rule guidance)</p>
<ul class="simple">
<li><p>Formalize the rules (regex/logical predicates) → encode them as embeddings.</p></li>
<li><p>Incorporate them into the noise prediction network (similar to prompts):</p></li>
</ul>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\epsilon_\theta(x_t,t,rule\_embedding)\]</div>
</div>
<ul class="simple">
<li><p>Effect: The model learns to follow these “rule signals” during denoising.</p></li>
</ul>
</li>
<li><p>Rule-driven noise masking</p>
<ul class="simple">
<li><p>Rules specify which tokens can be diffused and which must be preserved.</p></li>
<li><p>For example: If the rule states that verbs must be preserved → set the noise strength of the verb token embeddings to 0 and only add noise to other parts.</p></li>
<li><p>This is equivalent to the rules controlling the noise schedule.</p></li>
</ul>
</li>
</ol>
</section>
<section id="using-phishing-email-detection-rules-as-guidance">
<h3>Using phishing email detection rules as guidance<a class="headerlink" href="#using-phishing-email-detection-rules-as-guidance" title="Link to this heading">¶</a></h3>
<section id="transforming-rules-into-a-differentiable-approximately-differentiable-scorer">
<h4>Transforming rules into a “differentiable/approximately differentiable” scorer<a class="headerlink" href="#transforming-rules-into-a-differentiable-approximately-differentiable-scorer" title="Link to this heading">¶</a></h4>
<p>Phishing rules are often discrete (regex/keywords/structure). To use gradients in diffusion, we need to create differentiable approximations or surrogates:</p>
<ul class="simple">
<li><p>Structural (subject/greeting/Call To Action/sign-off)
Surrogate: Sequence labeler (BiLSTM/Transformer) scores the completeness of placeholder templates:
r_struct(x) ∈ [0,1]</p></li>
<li><p>Tone/urgency/pressure tactics
Surrogate: Sentiment/tone classifier (e.g., a specially trained “urgency” binary classifier) scores sentence-level embeddings:
r_urgency(x)</p></li>
<li><p>Domain/link inconsistency (only generate placeholders)
Surrogate: Template consistency checker (a differentiable surrogate is a small discriminator that takes the embedding difference vector of [LINK_TEXT] and [URL_HOST] as input and outputs the “inconsistency” probability):
r_mismatch(x)</p></li>
<li><p>Brand impersonation (placeholder level)
Surrogate: Named entity consistency/similarity constraint, aligning [ORG] with the organization mentioned in the text:
r_brand(x)</p></li>
</ul>
<p>Rule set:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\mathcal{R}=\{r_k(x)\}_{k=1}^K,\text{each}\quad r_k:\mathrm{text}\to[0,1]\]</div>
</div>
</section>
<section id="equations-for-rule-guided-diffusion">
<h4>Equations for rule-guided diffusion<a class="headerlink" href="#equations-for-rule-guided-diffusion" title="Link to this heading">¶</a></h4>
<p>In the latent space, diffusion is performed with the current state denoted as <span class="math notranslate nohighlight">\(x_t\)</span>. The standard model predicts noise <span class="math notranslate nohighlight">\(\epsilon_\theta(x_t,t,c)\)</span>, where <span class="math notranslate nohighlight">\(c\)</span> is the condition (e.g., task/topic).
Incorporating rule-guided gradient adjustment (similar to classifier-free guidance):</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\tilde{\epsilon}(x_t)=\epsilon_\theta(x_t,t,c)-\lambda\cdot\nabla_{x_t}\mathcal{E}(x_t),\quad\mathcal{E}(x_t)=-\sum_kw_k\log r_k(x_t)\]</div>
</div>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\mathcal{E}\)</span> is the “energy”: the more the rules are satisfied, the lower <span class="math notranslate nohighlight">\(\mathcal{E}\)</span> becomes.</p></li>
<li><p><span class="math notranslate nohighlight">\(w_k\)</span> is the rule weight; <span class="math notranslate nohighlight">\(\lambda\)</span> is the guidance strength.</p></li>
<li><p>Intuition: Denoise in the direction of increasing rule scores.</p></li>
</ul>
</section>
<section id="approaches-to-incorporate-rules-into-diffusion">
<h4>Approaches to incorporate rules into diffusion<a class="headerlink" href="#approaches-to-incorporate-rules-into-diffusion" title="Link to this heading">¶</a></h4>
<ol class="arabic simple">
<li><p>Gradient guidance of rule scores</p></li>
</ol>
<ul class="simple">
<li><p>At each sampling step, use a discriminator/scorer to obtain <span class="math notranslate nohighlight">\(r_k(x_t)\)</span>, and backpropagate to get <span class="math notranslate nohighlight">\(\nabla_{x_t}\log r_k\)</span>, which can be injected into the above equation.</p></li>
<li><p>Advantages: Simple to implement and compatible with any rule surrogate.</p></li>
<li><p>PS: Apply temperature/smoothing to each scorer to avoid gradient explosion.</p></li>
</ul>
<ol class="arabic simple" start="2">
<li><p>Masked diffusion (rules determine “which positions to diffuse”)</p></li>
</ol>
<ul class="simple">
<li><p>First, use rule templates to produce a skeleton (pure placeholders):
<code class="docutils literal notranslate"><span class="pre">[SUBJ]</span> <span class="pre">::</span> <span class="pre">[ORG]</span> <span class="pre">[NOTICE]</span></code>
<code class="docutils literal notranslate"><span class="pre">Dear</span> <span class="pre">[RECIPIENT],</span> <span class="pre">...</span> <span class="pre">[CTA]</span> <span class="pre">...</span> <span class="pre">[URL]</span> <span class="pre">...</span> <span class="pre">[SIGNOFF]</span></code></p></li>
<li><p>Create a noise mask <span class="math notranslate nohighlight">\(M\)</span>: slots that must satisfy the rules are frozen or have low noise, while unimportant slots have high noise to increase diversity.</p></li>
<li><p>During sampling:
<code class="docutils literal notranslate"><span class="pre">x_t</span> <span class="pre">=</span> <span class="pre">M</span> <span class="pre">⊙</span> <span class="pre">x_t</span> <span class="pre">+</span> <span class="pre">(1-M)</span> <span class="pre">⊙</span> <span class="pre">(x_t</span> <span class="pre">-</span> <span class="pre">η</span> <span class="pre">*</span> <span class="pre">guidance_grad)</span></code></p></li>
</ul>
<ol class="arabic simple" start="3">
<li><p>Projection/Constraint Sampling</p></li>
</ol>
<ul class="simple">
<li><p>After each denoising step, perform a projection: project the output back to the “template-valid” set (e.g., complete placeholders, valid order).</p></li>
<li><p>Very stable for strict rules (e.g., length, mandatory fields); for tone-related rules, apply additional guidance.</p></li>
</ul>
</section>
</section>
</section>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://arxiv.org/abs/2408.04220v1">Diffusion Guided Language Modeling</a> : ACL 2024</p></li>
<li><p><a class="reference external" href="https://arxiv.org/abs/2402.14285">Symbolic Music Generation with Non-Differentiable Rule Guided Diffusion</a> : ICML 2024</p></li>
</ul>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../tools/diffusers.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Diffusers Library for Quickly Building and Deploying Diffusion Models</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="datasets.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Datasets</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025, CNLab_Victoria
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Rule-guided Diffusion</a><ul>
<li><a class="reference internal" href="#methodology">Methodology</a><ul>
<li><a class="reference internal" href="#the-process-of-diffusion-models">The process of diffusion models</a></li>
<li><a class="reference internal" href="#incorporate-rules-into-diffusion">Incorporate rules into diffusion</a></li>
<li><a class="reference internal" href="#using-phishing-email-detection-rules-as-guidance">Using phishing email detection rules as guidance</a><ul>
<li><a class="reference internal" href="#transforming-rules-into-a-differentiable-approximately-differentiable-scorer">Transforming rules into a “differentiable/approximately differentiable” scorer</a></li>
<li><a class="reference internal" href="#equations-for-rule-guided-diffusion">Equations for rule-guided diffusion</a></li>
<li><a class="reference internal" href="#approaches-to-incorporate-rules-into-diffusion">Approaches to incorporate rules into diffusion</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#references">References</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/documentation_options.js?v=d45e8c67"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=46bd48cc"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    </body>
</html>